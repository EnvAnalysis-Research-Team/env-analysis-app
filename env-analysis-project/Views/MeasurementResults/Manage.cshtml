@using System.Text.Json
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Measurement Result";

    var jsonOptions = new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase };
    var emissionSourcesJson = JsonSerializer.Serialize(ViewBag.EmissionSources ?? new List<object>(), jsonOptions);
    var parametersJson = JsonSerializer.Serialize(ViewBag.Parameters ?? new List<object>(), jsonOptions);
}

<form id="measurementResultsAntiForgery" method="post" class="hidden">
    @Html.AntiForgeryToken()
</form>

<div class="max-w-full mx-auto p-4 space-y-4 h-full w-full">
    <section class="w-full h-full bg-white border border-gray-200 rounded-md shadow-sm p-4 space-y-4">
        <div class="flex flex-col lg:flex-row gap-4 w-full h-full">
            <div class="w-full lg:w-1/4 space-y-3">
                <div class="flex flex-col gap-1">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-semibold text-gray-800">Parameter trends</p>
                            <p class="text-xs text-gray-500">Select a parameter.</p>
                        </div>
                        <div class="inline-flex border border-gray-200 overflow-hidden text-xs font-medium">
                            <button type="button" data-trend-tab="water"
                                class="trend-tab-btn px-3 py-1.5 border-r border-gray-200 text-gray-600 hover:bg-gray-100 w-24">
                                Water
                            </button>
                            <button type="button" data-trend-tab="air"
                                class="trend-tab-btn px-3 py-1.5 bg-blue-600 text-white w-24">
                                Air
                            </button>
                        </div>
                    </div>
                </div>
                <select id="parameterTrendSelect"
                    class="w-full border border-gray-300 rounded-sm px-3 py-1.5 text-xs focus:ring-1 focus:ring-blue-500 focus:outline-none bg-white"></select>
                <p id="trendSelectHint" class="text-[11px] text-gray-500">
                    Hold Ctrl (or Command on Mac) and click to select multiple water parameters.
                </p>
                <form id="trendFilterForm"
                    class="space-y-3 text-xs bg-gray-50 border border-dashed border-gray-200 rounded-sm p-3">
                    <div class="grid grid-cols-1 gap-2">
                        <label class="font-medium text-gray-700" for="trendFilterSource">Source</label>
                        <select id="trendFilterSource"
                            class="border border-gray-300 rounded-sm px-3 py-1.5 focus:ring-1 focus:ring-blue-500 focus:outline-none bg-white">
                            <option value="">All sources</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 gap-2">
                        <label class="font-medium text-gray-700" for="trendFilterStart">From month</label>
                        <input id="trendFilterStart" type="month"
                            class="border border-gray-300 rounded-sm px-3 py-1.5 focus:ring-1 focus:ring-blue-500 focus:outline-none bg-white" />
                    </div>
                    <div class="grid grid-cols-1 gap-2">
                        <label class="font-medium text-gray-700" for="trendFilterEnd">To month</label>
                        <input id="trendFilterEnd" type="month"
                            class="border border-gray-300 rounded-sm px-3 py-1.5 focus:ring-1 focus:ring-blue-500 focus:outline-none bg-white" />
                    </div>
                    <div class="flex items-center gap-2 pt-1">
                        <button type="submit"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-sm font-semibold transition">
                            Apply filter
                        </button>
                        <button type="button" id="trendFilterReset"
                            class="px-3 py-1.5 rounded-sm border border-gray-300 text-gray-700 hover:bg-gray-100 transition">
                            Reset
                        </button>
                    </div>
                </form>
            </div>
            <div class="lg:w-3/4 w-full">
                <div class="relative h-72">
                    <canvas id="parameterTrendChart" class="absolute inset-0 w-full h-full invisible"></canvas>
                    <div id="trendChartPlaceholder"
                        class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm text-center px-6">
                        Select parameter(s) to generate the chart.
                    </div>
                </div>
            </div>
        </div>
        <div class="border-t border-gray-100 pt-4">
            <div class="flex items-center justify-between mb-2">
                <p class="text-xs font-semibold text-gray-700">Measurement values</p>
                <span class="text-[11px] text-gray-500">Filtered history</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-xs text-left table-auto">
                    <thead class="bg-gray-100 text-gray-700">
                        <tr>
                            <th class="px-3 py-2">Month</th>
                            <th class="px-3 py-2">Parameter</th>
                            <th class="px-3 py-2">Source</th>
                            <th class="px-3 py-2">Value</th>
                            <th class="px-3 py-2">Unit</th>
                        </tr>
                    </thead>
                    <tbody id="trendTableBody" class="divide-y divide-gray-100">
                        <tr id="trendTableEmptyRow">
                            <td colspan="5" class="px-3 py-5 text-center text-gray-400">
                                Select parameter(s) to see available measurements.
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div
                    class="pt-3 border-t border-gray-100 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between text-[11px] text-gray-600">
                    <div id="trendTableSummary">No data</div>
                    <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                        <label class="flex items-center gap-2">
                            <span class="text-gray-500">Rows per page</span>
                            <select id="trendTablePageSize"
                                class="border border-gray-300 rounded-sm px-2 py-1 text-xs focus:ring-1 focus:ring-blue-500 focus:outline-none">
                                <option value="6">6</option>
                                <option value="12" selected>12</option>
                            </select>
                        </label>
                        <div class="flex items-center gap-3">
                            <span id="trendTablePageLabel">Page 1 of 1</span>
                            <div class="inline-flex border border-gray-300 rounded-md overflow-hidden">
                                <button type="button" id="trendTablePrev"
                                    class="px-3 py-1.5 text-xs text-gray-600 disabled:opacity-40 disabled:cursor-not-allowed hover:bg-gray-100 transition">
                                    Prev
                                </button>
                                <button type="button" id="trendTableNext"
                                    class="px-3 py-1.5 text-xs text-gray-600 border-l border-gray-300 disabled:opacity-40 disabled:cursor-not-allowed hover:bg-gray-100 transition">
                                    Next
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section class="w-full h-full bg-white border border-gray-200 rounded-md shadow-sm p-4 space-y-4">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
            <div>
                <h1 class="text-lg font-semibold text-gray-800">Measurement Data</h1>
                <p class="text-xs text-gray-500">Track, approve, and audit measurements across air and water sources.
                </p>
            </div>
            <div class="w-full flex flex-col gap-2 sm:flex-row sm:items-center sm:flex-wrap sm:justify-end text-xs">
                <input id="resultsSearchInput" type="text" placeholder="Search source, parameter, or status..."
                    class="w-full sm:w-72 text-xs border border-gray-300 rounded-md px-2 py-1 focus:ring-1 focus:ring-blue-500 focus:outline-none" />
                <div class="flex flex-wrap items-center gap-2">
                    <button type="button" id="resultsSearchReset"
                        class="flex items-center gap-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-medium px-2.5 py-1 rounded-md transition">
                        <i class="bi bi-arrow-counterclockwise text-[9px]"></i>
                        Reset
                    </button>
                    <button type="button" id="openResultsFilterBtn"
                        class="flex items-center gap-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-medium px-2.5 py-1 rounded-md transition">
                        <i class="bi bi-sliders text-[9px]"></i>
                        Filters
                        <span id="activeFiltersBadge"
                            class="hidden text-[10px] font-semibold bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded-full leading-none">0</span>
                    </button>
                    <button id="exportResultsBtn" type="button"
                        class="flex items-center gap-1 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium px-2.5 py-1 rounded-md transition">
                        <i class="bi bi-download text-[9px]"></i>
                        Export
                    </button>
                    <button id="openImportResultsBtn" type="button"
                        class="flex items-center gap-1 border border-blue-200 bg-white text-blue-700 hover:bg-blue-50 text-xs font-medium px-2.5 py-1 rounded-md transition">
                        <i class="bi bi-upload text-[9px]"></i>
                        Import
                    </button>
                    <button id="openAddResultBtn" type="button"
                        class="flex items-center gap-1 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium px-2.5 py-1 rounded-md transition">
                        <i class="bi bi-plus text-[9px]"></i>
                        Add Result
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 space-y-4 w-full h-full">
            <div class="flex items-center justify-between">
                <div class="flex gap-2 border-b border-gray-200 text-xs font-medium">
                    <button type="button" class="tab-button px-4 py-2 -mb-px border-b-2 border-blue-600 text-blue-600"
                        data-tab="all">
                        All
                    </button>
                    <button type="button"
                        class="tab-button px-4 py-2 -mb-px border-b-2 border-transparent text-gray-500 hover:text-blue-600"
                        data-tab="water">
                        Water
                    </button>
                    <button type="button"
                        class="tab-button px-4 py-2 -mb-px border-b-2 border-transparent text-gray-500 hover:text-blue-600"
                        data-tab="air">
                        Air
                    </button>
                </div>
                <div class="flex items-center gap-4 text-[11px] text-gray-500">
                    <span id="waterCountBadge">0 results</span>
                    <span id="airCountBadge">0 results</span>
                </div>
            </div>

            <div id="tabPanel-all" class="tab-panel space-y-3">
                <table class="w-full text-xs text-left table-auto">
                    <thead class="bg-gray-100 text-gray-700">
                        <tr>
                            <th class="px-3 py-2">Type</th>
                            <th class="px-3 py-2">Source</th>
                            <th class="px-3 py-2">Parameter</th>
                            <th class="px-3 py-2">Value</th>
                            <th class="px-3 py-2">Measured</th>
                            <th class="px-3 py-2 text-center">Status</th>
                            <th class="px-3 py-2 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="allResultsBody" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="8" class="px-3 py-6 text-center text-gray-400">Loading measurements...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="tabPanel-water" class="tab-panel hidden space-y-3">
                <table class="w-full text-xs text-left table-auto">
                    <thead class="bg-gray-100 text-gray-700">
                        <tr>
                            <th class="px-3 py-2">Source</th>
                            <th class="px-3 py-2">Parameter</th>
                            <th class="px-3 py-2">Value</th>
                            <th class="px-3 py-2">Measured</th>
                            <th class="px-3 py-2 text-center">Status</th>
                            <th class="px-3 py-2 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="waterResultsBody" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="7" class="px-3 py-6 text-center text-gray-400">Loading water measurements...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="tabPanel-air" class="tab-panel hidden space-y-3">
                <table class="w-full text-xs text-left table-auto">
                    <thead class="bg-gray-100 text-gray-700">
                        <tr>
                            <th class="px-3 py-2">Source</th>
                            <th class="px-3 py-2">Parameter</th>
                            <th class="px-3 py-2">Value</th>
                            <th class="px-3 py-2">Measured</th>
                            <th class="px-3 py-2 text-center">Status</th>
                            <th class="px-3 py-2 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="airResultsBody" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="7" class="px-3 py-6 text-center text-gray-400">Loading air measurements...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="resultsPaginationBar"
                class="pt-2 border-t border-gray-200 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between text-[11px] text-gray-600">
                <div id="resultsPaginationSummary">No results</div>
                <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                    <label class="flex items-center gap-2">
                        <span class="text-gray-500">Rows per page</span>
                        <select id="resultsPageSize"
                            class="border border-gray-300 rounded-sm px-2 py-1 text-xs focus:ring-1 focus:ring-blue-500 focus:outline-none">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                        </select>
                    </label>
                    <div class="flex items-center gap-3">
                        <span id="resultsPaginationPageLabel">Page 1 of 1</span>
                        <div class="inline-flex border border-gray-300 rounded-md overflow-hidden">
                            <button type="button" id="resultsPrevPage"
                                class="px-3 py-1.5 text-xs text-gray-600 disabled:opacity-40 disabled:cursor-not-allowed hover:bg-gray-100 transition">
                                Prev
                            </button>
                            <button type="button" id="resultsNextPage"
                                class="px-3 py-1.5 text-xs text-gray-600 border-l border-gray-300 disabled:opacity-40 disabled:cursor-not-allowed hover:bg-gray-100 transition">
                                Next
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
<!-- Add Result Modal -->
<div id="addResultModal"
     class="app-modal fixed inset-0 bg-black bg-opacity-40 items-start justify-center z-50 p-4 pt-16 transition-all duration-200"
     aria-hidden="true">

    <div id="addResultModalPanel"
         class="app-modal__panel app-modal__panel--lg bg-white rounded-md shadow-lg w-full max-w-3xl p-5 space-y-5 h-fit">

        <!-- Header -->
        <div class="flex justify-between items-start border-b border-gray-200 pb-3">
            <div>
                <h2 class="text-sm font-semibold text-gray-700">Add Measurement Result</h2>
                <p class="text-xs text-gray-500">Record a new reading for water or air.</p>
            </div>
            <button type="button" id="closeAddResultBtn"
                    class="text-gray-500 hover:text-gray-700">
                <i class="bi bi-x-lg text-xs"></i>
            </button>
        </div>

        <!-- Content -->
        <div class="space-y-4 text-xs" id="addResultContent">

            <!-- Emission Source + Parameter -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Emission Source</label>
                    <select id="addResultSource"
                            class="w-full border border-gray-300 rounded-sm px-3 py-1.5
                                   focus:ring-1 focus:ring-blue-500 focus:outline-none">
                    </select>
                </div>
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Parameter</label>
                    <select id="addResultParameter"
                            class="w-full border border-gray-300 rounded-sm px-3 py-1.5
                                   focus:ring-1 focus:ring-blue-500 focus:outline-none">
                    </select>
                </div>
            </div>

            <!-- Value + Remark -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Value</label>
                    <input type="number" step="0.0001" id="addResultValue"
                           class="w-full border border-gray-300 rounded-sm px-3 py-1.5
                                  focus:ring-1 focus:ring-blue-500 focus:outline-none">
                </div>
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Remark</label>
                    <textarea id="addResultRemark" rows="3"
                              class="w-full border border-gray-300 rounded-sm px-3 py-1.5
                                     focus:ring-1 focus:ring-blue-500 focus:outline-none"></textarea>
                </div>
            </div>

            <!-- Hidden fields + Approve -->
            <div class="space-y-3">
                <input type="hidden" id="addResultDate">
                <input type="hidden" id="addResultApprovedAt">

                @if (User.IsInRole("Admin"))
                {
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="addResultApprovedCheckbox"
                               class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="addResultApprovedCheckbox"
                               class="text-xs text-gray-700">
                            Approve immediately
                        </label>
                    </div>
                }
            </div>
        </div>

        <!-- Footer -->
        <div class="flex justify-end space-x-2 pt-3 border-t border-gray-100">
            <button type="button" id="cancelAddResultBtn"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-medium px-3 py-1.5 rounded-sm transition">
                Cancel
            </button>
            <button type="button" id="saveResultBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium px-3 py-1.5 rounded-sm transition inline-flex items-center gap-1">
                <i class="bi bi-save text-[11px]"></i>
                Save Result
            </button>
        </div>

    </div>
</div>

<!-- Filter Results Modal -->
<div id="resultsFilterModal"
    class="app-modal fixed inset-0 bg-black bg-opacity-40 items-start justify-center z-50 p-4 pt-16 transition-all duration-200"
    aria-hidden="true">
    <div id="resultsFilterModalPanel"
        class="app-modal__panel app-modal__panel--md bg-white rounded-md shadow-lg w-full max-w-xl p-5 space-y-5 h-fit">
        <div class="flex justify-between items-start border-b border-gray-200 pb-3">
            <div>
                <h2 class="text-sm font-semibold text-gray-700">Filter Measurement Data</h2>
                <p class="text-xs text-gray-500">Narrow results by source, parameter, status, or time range.</p>
            </div>
            <button type="button" id="closeResultsFilterBtn" class="text-gray-500 hover:text-gray-700">
                <i class="bi bi-x-lg text-xs"></i>
            </button>
        </div>
        <div class="space-y-3 text-xs">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Emission Source</label>
                    <select id="filterSourceSelect"
                        class="w-full border border-gray-300 rounded-sm px-3 py-1.5 bg-white focus:ring-1 focus:ring-blue-500 focus:outline-none">
                        <option value="">All sources</option>
                    </select>
                </div>
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Parameter</label>
                    <select id="filterParameterSelect"
                        class="w-full border border-gray-300 rounded-sm px-3 py-1.5 bg-white focus:ring-1 focus:ring-blue-500 focus:outline-none">
                        <option value="">All parameters</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Status</label>
                    <select id="filterStatusSelect"
                        class="w-full border border-gray-300 rounded-sm px-3 py-1.5 bg-white focus:ring-1 focus:ring-blue-500 focus:outline-none">
                        <option value="">All statuses</option>
                        <option value="approved">Approved</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Measurement Date</label>
                    <div class="grid grid-cols-1 gap-2">
                        <div class="space-y-1">
                            <span class="text-xs text-gray-500 block">From</span>
                            <input type="date" id="filterStartDate"
                                class="w-full border border-gray-300 rounded-sm px-3 py-1.5 focus:ring-1 focus:ring-blue-500 focus:outline-none" />
                        </div>
                        <div class="space-y-1">
                            <span class="text-xs text-gray-500 block">To</span>
                            <input type="date" id="filterEndDate"
                                class="w-full border border-gray-300 rounded-sm px-3 py-1.5 focus:ring-1 focus:ring-blue-500 focus:outline-none" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex justify-between items-center pt-3 border-t border-gray-100">
            <button type="button" id="resetResultsFilterBtn"
                class="bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-medium px-3 py-1.5 rounded-sm transition inline-flex items-center gap-1">
                <i class="bi bi-arrow-counterclockwise text-[11px]"></i>
                Clear Filters
            </button>
            <div class="flex space-x-2">
                <button type="button" id="cancelResultsFilterBtn"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-medium px-3 py-1.5 rounded-sm transition">
                    Cancel
                </button>
                <button type="button" id="applyResultsFilterBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium px-3 py-1.5 rounded-sm transition inline-flex items-center gap-1">
                    <i class="bi bi-sliders text-[11px]"></i>
                    Apply Filters
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Import Results Modal -->
<div id="importResultsModal"
    class="app-modal fixed inset-0 bg-black bg-opacity-40 items-start justify-center z-50 p-4 pt-16 transition-all duration-200"
    aria-hidden="true">
    <div id="importResultsModalPanel"
        class="app-modal__panel app-modal__panel--lg bg-white rounded-md shadow-lg w-full max-w-3xl p-5 space-y-5 h-fit">
        <div class="flex justify-between items-start border-b border-gray-200 pb-3">
            <div>
                <h2 class="text-sm font-semibold text-gray-700">Import Measurement Results</h2>
                <p class="text-xs text-gray-500">Upload an Excel workbook, review detected rows, and confirm the import.</p>
            </div>
            <button type="button" id="closeImportResultsBtn" class="text-gray-500 hover:text-gray-700">
                <i class="bi bi-x-lg text-xs"></i>
            </button>
        </div>

        <div class="space-y-4 text-xs">
            <div class="flex items-center justify-between text-[11px] text-gray-500">
                <span id="importStepUploadLabel" class="font-medium text-blue-600">Step 1 · Upload file</span>
                <span id="importStepPreviewLabel" class="hidden font-medium text-blue-600">Step 2 · Review & confirm</span>
            </div>

            <div id="importStepUpload" class="space-y-4">
                <div class="space-y-2">
                    <label for="importSourceSelect" class="text-xs font-semibold text-gray-700">Emission Source</label>
                    <select id="importSourceSelect"
                        class="w-full border border-gray-300 rounded-sm px-3 py-1.5 text-xs bg-white focus:ring-1 focus:ring-blue-500 focus:outline-none">
                        <option value="">Select an emission source</option>
                    </select>
                    <p class="text-[11px] text-gray-500">All rows in this Excel file will be imported into the selected emission source.</p>
                </div>
                <div class="border border-dashed border-gray-300 rounded-md p-4 flex flex-col gap-3 items-center text-center">
                    <p class="text-sm font-semibold text-gray-700">Select your Excel file</p>
                    <p class="text-xs text-gray-500">Supported columns: EmissionSourceID, ParameterCode, Value, MeasurementDate or EntryDate, Unit, Remark, IsApproved, ApprovedAt.</p>
                    <label class="inline-flex items-center gap-2 cursor-pointer bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold px-4 py-2 rounded-md transition">
                        <i class="bi bi-upload text-[10px]"></i>
                        <span id="importFileLabel">Choose file</span>
                        <input type="file" id="importFileInput" class="hidden" accept=".xlsx,.xls,.csv" />
                    </label>
                    <p class="text-[11px] text-gray-500">Only .xlsx or .xls files are parsed. Data is staged until you confirm the import.</p>
                </div>
            </div>

            <div id="importStepPreview" class="space-y-4 hidden">
                <div class="rounded-md border border-blue-100 bg-blue-50 p-3 text-[11px] text-blue-700 flex flex-col gap-1">
                    <p id="importPreviewSummary" class="font-semibold">No rows detected yet.</p>
                    <p id="importPreviewHint">Resolve the highlighted errors before confirming to avoid skipping rows.</p>
                </div>
                <div class="border border-gray-200 rounded-md overflow-hidden">
                    <div class="overflow-x-auto max-h-72">
                        <table class="w-full text-[11px] text-left">
                            <thead class="bg-gray-100 text-gray-600">
                                <tr>
                                    <th class="px-3 py-2">Row</th>
                                    <th class="px-3 py-2">Source</th>
                                    <th class="px-3 py-2">Parameter</th>
                                    <th class="px-3 py-2">Value</th>
                                    <th class="px-3 py-2">Measured</th>
                                    <th class="px-3 py-2">Status</th>
                                </tr>
                            </thead>
                            <tbody id="importPreviewTableBody" class="divide-y divide-gray-100">
                                <tr>
                                    <td colspan="6" class="px-3 py-6 text-center text-gray-400">Upload a file and click
                                        “Preview data” to see the detected rows.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between border-t border-gray-100 pt-3">
            <button type="button" id="backImportResultsBtn"
                class="hidden text-xs font-medium px-3 py-1.5 rounded-sm border border-gray-300 text-gray-700 hover:bg-gray-100 transition">
                Back
            </button>
            <div class="flex items-center gap-2 sm:ml-auto">
                <button type="button" id="cancelImportResultsBtn"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-medium px-3 py-1.5 rounded-sm transition">
                    Cancel
                </button>
                <button type="button" id="previewImportResultsBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium px-3 py-1.5 rounded-sm transition inline-flex items-center gap-1">
                    <i class="bi bi-search text-[10px]"></i>
                    Preview data
                </button>
                <button type="button" id="confirmImportResultsBtn"
                    class="hidden bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium px-3 py-1.5 rounded-sm transition inline-flex items-center gap-1">
                    <i class="bi bi-check2-circle text-[10px]"></i>
                    Import rows
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Result Modal -->
<div id="editResultModal"
    class="app-modal fixed inset-0 bg-black bg-opacity-40 items-start justify-center z-50 p-4 pt-16 transition-all duration-200"
    aria-hidden="true">
    <div
        class="app-modal__panel app-modal__panel--lg bg-white rounded-md shadow-lg w-full max-w-2xl p-5 space-y-5 h-fit">
        <div class="flex justify-between items-start border-b border-gray-200 pb-3">
            <div>
                <h2 class="text-sm font-semibold text-gray-700">Edit Measurement Result</h2>
                <p class="text-xs text-gray-500">Update measurements, remarks, or approval status.</p>
            </div>
            <button type="button" id="closeEditResultBtn" class="text-gray-500 hover:text-gray-700">
                <i class="bi bi-x-lg text-xs"></i>
            </button>
        </div>

        <input type="hidden" id="editResultId" />

        <div class="space-y-4 text-xs">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Emission Source</label>
                    <select id="editResultSource"
                        class="w-full border border-gray-300 rounded-sm px-3 py-1.5 focus:ring-1 focus:ring-blue-500 focus:outline-none">
                    </select>
                </div>
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Parameter</label>
                    <select id="editResultParameter"
                        class="w-full border border-gray-300 rounded-sm px-3 py-1.5 focus:ring-1 focus:ring-blue-500 focus:outline-none">
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Value</label>
                    <input type="number" step="0.0001" id="editResultValue"
                        class="w-full border border-gray-300 rounded-sm px-3 py-1.5 focus:ring-1 focus:ring-blue-500 focus:outline-none" />
                </div>
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Remark</label>
                    <textarea id="editResultRemark" rows="3"
                        class="w-full border border-gray-300 rounded-sm px-3 py-1.5 focus:ring-1 focus:ring-blue-500 focus:outline-none"></textarea>
                </div>
            </div>

            <div class="space-y-3">
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Measurement Date</label>
                    <input type="datetime-local" id="editResultDate" readonly tabindex="-1"
                        class="w-full border border-gray-300 rounded-sm px-3 py-1.5 bg-gray-100 text-gray-600 cursor-not-allowed" />
                    <p class="text-xs text-gray-500 mt-1">
                        Timestamp locked after creation.
                    </p>
                </div>
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Approved At</label>
                    <input type="datetime-local" id="editResultApprovedAt" readonly tabindex="-1"
                        class="w-full border border-gray-300 rounded-sm px-3 py-1.5 bg-gray-100 text-gray-600 cursor-not-allowed" />
                    <p class="text-xs text-gray-500 mt-1">
                        Auto-managed when approval status changes.
                    </p>
                </div>
                @if (User.IsInRole("Admin"))
                {
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="editResultApprovedCheckbox"
                            class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" />
                        <label for="editResultApprovedCheckbox" class="text-xs text-gray-700">
                            Approve this measurement
                        </label>
                    </div>
                }
            </div>
        </div>

        <div class="flex justify-between items-center pt-3 border-t border-gray-100">
            <button type="button" id="deleteResultBtn"
                class="text-xs text-red-600 hover:text-red-700 inline-flex items-center gap-1">
                <i class="bi bi-trash-fill text-[11px]"></i>
                Delete Result
            </button>

            <div class="flex space-x-2">
                <button type="button" id="cancelEditResultBtn"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-medium px-3 py-1.5 rounded-sm transition">
                    Close
                </button>
                <button type="button" id="updateResultBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium px-3 py-1.5 rounded-sm transition inline-flex items-center gap-1">
                    <i class="bi bi-save text-[11px]"></i>
                    Save changes
                </button>
            </div>
        </div>

    </div>
</div>


@section Styles {
    <link rel="stylesheet" href="~/css/modal-effects.css" asp-append-version="true" />
}

@section Scripts {
    <script>
        function loadPage() {
            window.location.reload();
        }

        window.measurementResultLookups = {
            emissionSources: @Html.Raw(emissionSourcesJson),
            parameters: @Html.Raw(parametersJson)
            };
        window.measurementResultRoutes = {
            list: '@Url.Action("ListData", "MeasurementResults")',
            detail: '@Url.Action("DetailData", "MeasurementResults")',
            create: '@Url.Action("CreateAjax", "MeasurementResults")',
            update: '@Url.Action("UpdateAjax", "MeasurementResults")',
            delete: '@Url.Action("DeleteAjax", "MeasurementResults")',
            trend: '@Url.Action("ParameterTrends", "MeasurementResults")',
            export: '@Url.Action("ExportCsv", "MeasurementResults")',
            importPreview: '@Url.Action("ImportPreview", "MeasurementResults")',
            importConfirm: '@Url.Action("ImportConfirm", "MeasurementResults")'
        };
        window.measurementResultPermissions = {
            canApprove: @User.IsInRole("Admin").ToString().ToLowerInvariant()
            };
    </script>
    <script src="~/js/measurement-results-management.js" asp-append-version="true"></script>
}
