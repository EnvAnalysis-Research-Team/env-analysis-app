@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Account Management";
    var roleOptions = ViewBag.AvailableRoles as IEnumerable<string> ?? Array.Empty<string>();
    var selectedRoleFilter = Context.Request.Query["roleFilter"].ToString();
    var selectedSortOption = Context.Request.Query["sortOption"].ToString();
    var searchValue = Context.Request.Query["searchString"].ToString();
}
@model IEnumerable<env_analysis_project.Models.ApplicationUser>

<form id="antiForgeryForm" method="post" style="display:none">
    @Html.AntiForgeryToken()
</form>

@{
    var currentPage = ViewBag.Page is int p ? p : 1;
    var currentPageSize = ViewBag.PageSize is int ps ? ps : 10;
    var totalItems = ViewBag.TotalItems is int ti ? ti : Model?.Count() ?? 0;
    var totalPages = ViewBag.TotalPages is int tp ? tp : 1;
    var startItem = totalItems == 0 ? 0 : (currentPage - 1) * currentPageSize + 1;
    var endItem = totalItems == 0 ? 0 : Math.Min(currentPage * currentPageSize, totalItems);
}

<div class="max-w-7xl mx-auto bg-white shadow-sm rounded-md py-4 px-6 text-xs space-y-4">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <!-- Left: Title -->
        <div>
            <h1 class="text-lg font-semibold text-gray-800">Account Management</h1>
            <p class="text-xs text-gray-500">
            </p>
        </div>

        <!-- Right: Actions -->
        <div class="flex flex-wrap items-center gap-2">
            <button type="button"
                class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-3 py-1.5 rounded-md transition flex items-center gap-1"
                onclick="openAddModal()">
                <i class="bi bi-person-plus text-[10px]"></i> Add
            </button>

            <button type="button" id="exportUsersBtn"
                class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-3 py-1.5 rounded-md transition flex items-center gap-1">
                <i class="bi bi-file-earmark-excel text-[10px]"></i> Export
            </button>

            <button type="button"
                class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium px-3 py-1.5 rounded-md transition flex items-center gap-1"
                onclick="location.reload()">
                <i class="bi bi-arrow-clockwise text-[10px]"></i> Refresh
            </button>

            <button type="button"
                class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium px-3 py-1.5 rounded-md transition flex items-center gap-1"
                onclick="openFilterModal()">
                <i class="bi bi-funnel text-[10px]"></i> Filters
            </button>
        </div>
    </div>


    <div class="overflow-x-auto border border-gray-200 rounded-md">
        <table class="min-w-full text-left text-gray-700">
            <thead class="bg-gray-100 text-gray-600">
                <tr>
                    <th class="px-4 py-2 font-semibold">Full Name</th>
                    <th class="px-4 py-2 font-semibold">Email</th>
                    <th class="px-4 py-2 font-semibold">Role</th>
                    <th class="px-4 py-2 font-semibold">Created At</th>
                    <th class="px-4 py-2 font-semibold text-center">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                @if (Model != null && Model.Any())
                {
                    foreach (var user in Model)
                    {
                        <tr class="hover:bg-gray-50 transition">
                            <td class="px-4 py-2">@user.FullName</td>
                            <td class="px-4 py-2">@user.Email</td>
                            <td class="px-4 py-2">@user.Role</td>
                            <td class="px-4 py-2">@user.CreatedAt?.ToString("yyyy-MM-dd")</td>
                            <td class="px-4 py-2 text-center">
                                <div class="flex items-center justify-center gap-2">
                                    <button type="button" onclick="openEditModal('@user.Id')"
                                        class="w-7 h-7 flex items-center justify-center border border-blue-300 text-blue-600 rounded-md hover:bg-blue-50 transition"
                                        title="View & Edit User">
                                        <i class="bi bi-pencil text-[10px]"></i>
                                    </button>
                                    <button type="button" onclick="deleteUser('@user.Id')"
                                        class="w-7 h-7 flex items-center justify-center border border-red-400 text-red-500 rounded-md hover:bg-red-50 transition"
                                        title="Delete User">
                                        <i class="bi bi-trash text-[10px]"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" class="px-4 py-4 text-center text-gray-400">
                            No users found.
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <div
        class="pt-2 border-t border-gray-100 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between text-[11px] text-gray-600">
        <div>
            @(totalItems == 0
                        ? "No users to display"
                        : $"Showing {startItem}-{endItem} of {totalItems} users")
        </div>
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
            <label class="flex items-center gap-2">
                <span class="text-gray-500">Rows per page</span>
                <select id="userPageSizeSelect"
                    class="border border-gray-300 rounded-sm px-2 py-1 text-xs focus:ring-1 focus:ring-blue-500 focus:outline-none">
                    <option value="10" selected="@(currentPageSize == 10)">10</option>
                    <option value="25" selected="@(currentPageSize == 25)">25</option>
                    <option value="50" selected="@(currentPageSize == 50)">50</option>

                </select>
            </label>
            <div class="flex items-center gap-3">
                <span>Page @currentPage of @Math.Max(totalPages, 1)</span>
                <div class="inline-flex border border-gray-300 rounded-md overflow-hidden">
                    <button type="button"
                        class="px-3 py-1.5 text-xs text-gray-600 disabled:opacity-40 disabled:cursor-not-allowed hover:bg-gray-100 transition"
                        onclick="changeUserPage(@(currentPage - 1))" @(currentPage <= 1 ? "disabled" : null)>
                        Prev
                    </button>
                    <button type="button"
                        class="px-3 py-1.5 text-xs text-gray-600 border-l border-gray-300 disabled:opacity-40 disabled:cursor-not-allowed hover:bg-gray-100 transition"
                        onclick="changeUserPage(@(currentPage + 1))" @(currentPage >= totalPages || totalItems == 0 ?
                                                                                             "disabled" : null)>
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<form id="paginationForm" method="get" class="hidden">
    <input type="hidden" name="searchString" value="@searchValue" />
    <input type="hidden" name="roleFilter" value="@selectedRoleFilter" />
    <input type="hidden" name="sortOption" value="@selectedSortOption" />
    <input type="hidden" name="page" value="@currentPage" />
    <input type="hidden" name="pageSize" value="@currentPageSize" />
</form>

<!-- Filter Modal -->
<div id="filterModal"
    class="app-modal fixed inset-0 bg-black bg-opacity-40 items-start justify-center z-50 p-4 pt-16 transition-all duration-200"
    aria-hidden="true">
    <div id="filterModalPanel"
        class="app-modal__panel app-modal__panel--sm bg-white rounded-md shadow-lg w-full max-w-md p-5 space-y-5 h-fit">
        <div class="flex justify-between items-start border-b border-gray-200 pb-3">
            <div>
                <h2 class="text-sm font-semibold text-gray-700">Search & Filter Users</h2>
                <p class="text-xs text-gray-500">Refine the users list by role, sorting, or keywords.</p>
            </div>
            <button type="button" class="text-gray-500 hover:text-gray-700" onclick="closeFilterModal()">
                <i class="bi bi-x-lg text-xs"></i>
            </button>
        </div>

        <form asp-action="Index" method="get" class="space-y-4 text-xs">
            <div>
                <label class="block text-gray-700 font-medium mb-1">Search</label>
                <input type="text" name="searchString" value="@searchValue"
                    class="w-full border border-gray-300 rounded-sm px-3 py-1.5 focus:ring-1 focus:ring-blue-500 focus:outline-none"
                    placeholder="Search by email or name..." />
            </div>

            <div>
                <label class="block text-gray-700 font-medium mb-1">Role</label>
                <select name="roleFilter"
                    class="w-full border border-gray-300 rounded-sm px-3 py-1.5 bg-white focus:ring-1 focus:ring-blue-500 focus:outline-none">
                    <option value="" selected="@(string.IsNullOrEmpty(selectedRoleFilter) ? "selected" : null)">All
                        Roles</option>
                    @foreach (var role in roleOptions)
                    {
                        var isSelected = string.Equals(selectedRoleFilter, role, StringComparison.OrdinalIgnoreCase);
                        <option value="@role" selected="@(isSelected ? "selected" : null)">@role</option>
                    }
                </select>
            </div>

            <div>
                <label class="block text-gray-700 font-medium mb-1">Sort By</label>
                <select name="sortOption"
                    class="w-full border border-gray-300 rounded-sm px-3 py-1.5 bg-white focus:ring-1 focus:ring-blue-500 focus:outline-none">
                    <option value="date_desc" selected="@(selectedSortOption == "date_desc" ? "selected" : null)">Newest
                        First</option>
                    <option value="date_asc" selected="@(selectedSortOption == "date_asc" ? "selected" : null)">Oldest
                        First</option>
                    <option value="name_asc" selected="@(selectedSortOption == "name_asc" ? "selected" : null)">Name A -
                        Z</option>
                    <option value="name_desc" selected="@(selectedSortOption == "name_desc" ? "selected" : null)">Name Z
                        - A</option>
                </select>
            </div>

            <div class="flex justify-between items-center pt-3 border-t border-gray-100">
                <a href="@Url.Action("Index", "UserManagement")"
                    class="px-3 py-1.5 rounded-sm border border-gray-200 text-gray-600 hover:bg-gray-50 transition text-xs font-medium">
                    Reset
                </a>
                <button type="submit"
                    class="px-3 py-1.5 rounded-sm bg-blue-600 text-white text-xs font-medium hover:bg-blue-700 transition">
                    Apply Filters
                </button>
            </div>
        </form>
    </div>
</div>



<!-- Edit User Modal -->
<div id="editModal"
    class="app-modal fixed inset-0 bg-black bg-opacity-40 items-start justify-center z-50 p-4 pt-16 transition-all duration-200"
    aria-hidden="true">
    <div
        class="app-modal__panel app-modal__panel--md bg-white rounded-md shadow-lg w-full max-w-xl p-5 space-y-5 h-fit">
        <div class="flex justify-between items-start border-b border-gray-200 pb-3">
            <div>
                <h2 class="text-sm font-semibold text-gray-700">Update User</h2>
                <p class="text-xs text-gray-500">Modify credentials, roles, or display info.</p>
            </div>
            <button type="button" class="text-gray-500 hover:text-gray-700" onclick="closeEditModal()">
                <i class="bi bi-x-lg text-xs"></i>
            </button>
        </div>

        <form id="editUserForm" method="post" class="space-y-3 text-xs text-gray-700" onsubmit="return false;">
            @Html.AntiForgeryToken()
            <input type="hidden" name="Id" id="editId" />

            <div>
                <label class="block font-medium text-gray-700 mb-1">Email</label>
                <input name="Email" id="editEmail" type="email" required
                    class="w-full border border-gray-300 rounded-sm px-3 py-1.5 focus:ring-1 focus:ring-blue-500 focus:outline-none" />
            </div>

            <div>
                <label class="block font-medium text-gray-700 mb-1">Full Name</label>
                <input name="FullName" id="editFullName" type="text"
                    class="w-full border border-gray-300 rounded-sm px-3 py-1.5 focus:ring-1 focus:ring-blue-500 focus:outline-none" />
            </div>

            <div>
                <label class="block font-medium text-gray-700 mb-1">Role</label>
                <select name="Role" id="editRole"
                    class="w-full border border-gray-300 rounded-sm px-3 py-1.5 bg-white focus:ring-1 focus:ring-blue-500 focus:outline-none">
                    <option value="">-- Select Role --</option>
                    @foreach (var role in roleOptions)
                    {
                        <option value="@role">@role</option>
                    }
                </select>
            </div>

            <div>
                <label class="block font-medium text-gray-700 mb-1">Created At</label>
                <input id="editCreatedAt" type="text" readonly
                    class="w-full border border-gray-200 bg-gray-100 rounded-sm px-3 py-1.5 text-gray-500 cursor-not-allowed" />
            </div>

            <div class="flex justify-end pt-3 border-t border-gray-100 space-x-2">
                <button type="button" onclick="closeEditModal()"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-medium px-3 py-1.5 rounded-sm transition">
                    Close
                </button>
                <button type="button" onclick="saveUserChanges()"
                    class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium px-3 py-1.5 rounded-sm transition inline-flex items-center gap-1">
                    <i class="bi bi-save text-[11px]"></i>
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add User Modal -->
<div id="addModal"
    class="app-modal fixed inset-0 bg-black bg-opacity-40 items-start justify-center z-50 p-4 pt-16 transition-all duration-200"
    aria-hidden="true">
    <div
        class="app-modal__panel app-modal__panel--md bg-white rounded-md shadow-lg w-full max-w-xl p-5 space-y-5 h-fit">
        <div class="flex justify-between items-start border-b border-gray-200 pb-3">
            <div>
                <h2 class="text-sm font-semibold text-gray-700">Add New User</h2>
                <p class="text-xs text-gray-500">Provide base details and initial credentials.</p>
            </div>
            <button type="button" class="text-gray-500 hover:text-gray-700" onclick="closeAddModal()">
                <i class="bi bi-x-lg text-xs"></i>
            </button>
        </div>

        <form id="addUserForm" class="space-y-4 text-xs" onsubmit="return false;">
            @Html.AntiForgeryToken()

            <div>
                <label class="block font-medium text-gray-700 mb-1">Email</label>
                <input id="addEmail" name="Email" type="email" required
                    class="w-full border border-gray-300 rounded-sm px-3 py-1.5 focus:ring-1 focus:ring-blue-500 focus:outline-none" />
            </div>

            <div>
                <label class="block font-medium text-gray-700 mb-1">Full Name</label>
                <input id="addFullName" name="FullName" type="text" required
                    class="w-full border border-gray-300 rounded-sm px-3 py-1.5 focus:ring-1 focus:ring-blue-500 focus:outline-none" />
            </div>

            <div>
                <label class="block font-medium text-gray-700 mb-1">Role</label>
                <select id="addRole" name="Role"
                    class="w-full border border-gray-300 rounded-sm px-3 py-1.5 bg-white focus:ring-1 focus:ring-blue-500 focus:outline-none">
                    <option value="">-- Select Role --</option>
                    @foreach (var role in roleOptions)
                    {
                        <option value="@role">@role</option>
                    }
                </select>
            </div>

            <div>
                <label class="block font-medium text-gray-700 mb-1">Password</label>
                <input id="addPassword" name="password" type="password" required minlength="8"
                    class="w-full border border-gray-300 rounded-sm px-3 py-1.5 focus:ring-1 focus:ring-blue-500 focus:outline-none" />
            </div>

            <div class="flex justify-end space-x-2 pt-3 border-t border-gray-100">
                <button type="button" onclick="closeAddModal()"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-medium px-3 py-1.5 rounded-sm transition">
                    Cancel
                </button>
                <button type="button" onclick="createUser()"
                    class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium px-3 py-1.5 rounded-sm transition inline-flex items-center gap-1">
                    <i class="bi bi-plus text-[11px]"></i>
                    Create
                </button>
            </div>
        </form>
    </div>
</div>



@section Styles {
    <link rel="stylesheet" href="~/css/modal-effects.css" asp-append-version="true" />
}

@section Scripts {

    <script src="~/js/user-management.js" asp-append-version="true"></script>

    <partial name="_ValidationScriptsPartial" />

}
